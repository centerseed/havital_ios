# Garmin Connect - Frontend Integration Guide (v1.0)

This document provides instructions for the frontend (mobile app) team to integrate with the backend API for connecting a user's Garmin account.

## Overview

The integration uses the **OAuth 2.0 Authorization Code Flow with PKCE**. This is a secure method that allows our app to obtain permission to access data from a user's Garmin account without ever handling their password.

The flow consists of four main steps from the frontend perspective:

1.  **Initiate Connection**: The user clicks a "Connect to Garmin" button in the app.
2.  **User Authorization**: The app directs the user to the Garmin authorization page in a web browser/webview. The app must generate and include a `code_verifier`, `code_challenge`, and `state` parameter.
3.  **Handle Callback**: After the user authorizes the connection, Garmin redirects them back to our app via a pre-configured callback URL (deep link). This callback includes an `authorization_code`.
4.  **Complete Connection**: The app sends the received `authorization_code` and the original `code_verifier` to our backend API to finalize the connection.

## Step-by-Step Implementation

### Step 1: Generate PKCE Parameters

Before starting the flow, the app must generate two values:

-   **`code_verifier`**: A cryptographically random string (e.g., 43-128 characters long). This should be stored securely in the app for later use.
-   **`code_challenge`**: A `BASE64URL-ENCODE(SHA256(ASCII(code_verifier)))` transformation of the verifier.

### Step 2: Construct the Authorization URL and Redirect

The app constructs the Garmin authorization URL and opens it in a browser or webview.

**Garmin Authorization Endpoint URL:**
`https://connect.garmin.com/oauth2Confirm`

**Required Query Parameters:**

| Parameter            | Description                                                                                             | Example Value                             |
| -------------------- | ------------------------------------------------------------------------------------------------------- | ----------------------------------------- |
| `client_id`          | Our application's client ID provided by Garmin.                                                         | `YOUR_GARMIN_CLIENT_ID`                   |
| `response_type`      | Must be `code`.                                                                                         | `code`                                    |
| `redirect_uri`       | The callback URL that Garmin will redirect to. This must be a deep link into our app.                     | `YOUR_APP_CALLBACK_URI` (e.g., `havital://callback/garmin`) |
| `scope`              | The permissions we are requesting.                                                                      | `activity_read`                           |
| `state`              | A random string generated by the app to prevent CSRF attacks. It should be stored and verified later. | `random_state_string_123`                 |
| `code_challenge`     | The PKCE code challenge generated in Step 1.                                                            | `E9Mel...`                                |
| `code_challenge_method`| Must be `S256`.                                                                                         | `S256`                                    |

**Example URL:**
```
https://connect.garmin.com/oauth2Confirm?client_id=YOUR_GARMIN_CLIENT_ID&response_type=code&redirect_uri=havital://callback/garmin&scope=activity_read&state=random_state_string_123&code_challenge=E9Mel...&code_challenge_method=S256
```
*(Note: `YOUR_GARMIN_CLIENT_ID` will be provided by the backend/infra team.)*

### Step 3: Handle the App Callback

After the user approves the connection on Garmin's website, Garmin will redirect back to the `redirect_uri` specified. The app needs to be configured to handle this deep link.

The callback URL will contain:
-   `code`: The authorization code.
-   `state`: The same state string sent in Step 2.

The app should **verify that the received `state` matches the one it stored** before proceeding.

### Step 4: Call Backend API to Finalize Connection

Once the app has the `authorization_code` and has verified the `state`, it must make a `POST` request to our backend.

**Backend Endpoint:**
`POST /connect/{provider}/callback`
For Garmin, this will be: `POST /connect/garmin/callback`

**Headers:**
-   `Authorization`: `Bearer <user_firebase_jwt>`
-   `Content-Type`: `application/json`

**Request Body:**

```json
{
  "authorization_code": "THE_CODE_FROM_GARMIN_CALLBACK",
  "code_verifier": "THE_VERIFIER_GENERATED_IN_STEP_1"
}
```

**Responses:**

-   **`200 OK` (Success)**: The connection was successful. The backend has securely stored the tokens.

    ```json
    {
      "message": "Connection completed successfully.",
      "data": {
        "user_connection_id": "test_user_123_garmin"
      }
    }
    ```

-   **`400 Bad Request`**: The request was malformed (e.g., missing parameters).
-   **`401 Unauthorized`**: The user's Firebase JWT is missing or invalid.
-   **`500 Internal Server Error`**: An error occurred on the backend while trying to exchange the code for tokens with Garmin. The app should inform the user to try again later.

This completes the connection flow. 