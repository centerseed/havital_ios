# Apple Health 運動記錄上傳優化說明

## 改進概述

針對用戶反饋的「從 Garmin Connect 同步跑步紀錄到 Apple Health 後，花很多時間同步但資料沒有上傳」的問題，我們對上傳流程進行了全面優化。

## 核心問題分析

### 1. **手機鎖定導致數據無法訪問** 🔒
- **問題**：手機鎖定時，HealthKit 會返回 `Protected health data is inaccessible` 錯誤
- **舊行為**：系統會重試 5 次，每次等待 30 秒，總計 2.5 分鐘
- **用戶影響**：上傳流程被卡住，用戶體驗極差

### 2. **Garmin 同步數據缺少詳細時間序列** 📊
- **問題**：從 Garmin Connect 同步到 Apple Health 的跑步記錄通常只有摘要數據（總距離、平均心率等），缺少秒級的心率、GPS、步頻詳細數據點
- **舊行為**：系統會一直重試獲取這些不存在的數據
- **用戶影響**：浪費大量時間在不可能成功的重試上

### 3. **批量上傳被阻塞** 🚫
- **問題**：批量上傳是順序處理，如果某個運動卡在重試，整個批次都會被阻塞
- **舊行為**：沒有超時機制，一個問題運動可能阻塞所有運動的上傳
- **用戶影響**：即使有正常的運動記錄，也無法上傳

---

## 優化後的重試策略

### 📋 重試次數和間隔優化

| 數據類型 | 舊策略 | 新策略 | 節省時間 |
|---------|--------|--------|----------|
| **心率數據** | 5 次 × 30 秒 = 2.5 分鐘 | 2 次 × 10 秒 = 20 秒 | 節省 2 分 10 秒 |
| **速度數據** | 3 次 × 30 秒 = 1.5 分鐘 | 2 次 × 10 秒 = 20 秒 | 節省 1 分 10 秒 |
| **步頻數據** | 5 次 × 30 秒 = 2.5 分鐘 | 2 次 × 10 秒 = 20 秒 | 節省 2 分 10 秒 |
| **第三方數據源** | 同上 | 1 次 × 5 秒 = 5 秒 | 節省 > 2 分鐘 |

### 🎯 快速失敗機制

#### 1. **手機鎖定錯誤立即停止**
```
檢測到: "Protected health data is inaccessible"
行為: 立即停止重試，不再等待
日誌: "🔒 檢測到手機鎖定錯誤，停止重試（請解鎖手機後數據會自動上傳）"
```

#### 2. **第三方數據源特殊處理**
```
檢測到: Garmin Connect / Polar Flow / Strava 等
行為: 最多重試 1 次，間隔 5 秒
日誌: "🔍 檢測到第三方數據源 (Garmin Connect)，減少重試次數"
```

#### 3. **授權問題快速失敗**
```
檢測到: authorization / not determined 錯誤
行為: 立即停止重試
日誌: "🔐 第三方數據源授權問題，停止重試"
```

---

## 上傳流程說明

### ✅ **會正確上傳的情況**

#### 1. **Apple Watch 原生運動記錄**
- ✅ 有完整的心率、GPS、步頻數據
- ✅ 通常 30-40 秒內完成上傳（含重試）
- ✅ 資料完整度高，配速分析準確

#### 2. **iPhone 內建健身 App 記錄**
- ✅ 有心率數據（如配對 Apple Watch）
- ✅ 有 GPS 數據
- ✅ 可能缺少步頻，但不影響上傳

#### 3. **第三方設備（手動錄製）**
- ✅ 如 Garmin 手錶直接錄製並同步到 Apple Health
- ✅ 有分圈資料和總距離即可上傳
- ⚠️ 可能缺少詳細心率曲線，但有平均值

### ⏳ **會重試的情況**

#### 1. **數據暫時不可用**（最多 2 次重試 × 10 秒）
- 📱 App 剛啟動，HealthKit 數據尚未完全載入
- 📱 網路瞬斷導致 API 調用失敗
- 📱 系統資源暫時緊張

#### 2. **第三方數據源**（最多 1 次重試 × 5 秒）
- 🔌 Garmin Connect 同步的運動
- 🔌 Strava 同步的運動
- 🔌 其他第三方應用同步的運動

### ❌ **會快速失敗的情況**

#### 1. **手機鎖定**
- 🔒 錯誤訊息：`Protected health data is inaccessible`
- 🔒 行為：立即停止重試
- 🔒 解決方案：解鎖手機後，系統會自動重新嘗試上傳

#### 2. **數據完全缺失**
- ❌ 運動記錄沒有任何心率數據
- ❌ 跑步運動沒有距離或速度信息
- ❌ 第三方應用只同步了基本資訊（名稱、時間）

#### 3. **授權問題**
- 🔐 用戶未授權訪問特定數據類型
- 🔐 第三方應用的健康數據未授權
- 🔐 行為：立即停止重試，記錄失敗原因

---

## 批量上傳優化

### 舊行為
```
批量上傳 4 筆運動
├─ 運動 1: 重試 5 次心率 (2.5分鐘) → 失敗
├─ 運動 2: 被阻塞，等待運動 1
├─ 運動 3: 被阻塞，等待運動 1
└─ 運動 4: 被阻塞，等待運動 1

總耗時: > 10 分鐘（如果全部失敗）
```

### 新行為
```
批量上傳 4 筆運動
├─ 運動 1: 最多 60 秒超時 → 超時後跳過
├─ 運動 2: 立即處理 → 20 秒完成
├─ 運動 3: 立即處理 → 20 秒完成
└─ 運動 4: 立即處理 → 20 秒完成

總耗時: 約 2 分鐘（包含 1 個失敗運動）
```

### 批量上傳改進
- ⏱️ **每個運動 60 秒超時**：避免整個批次被阻塞
- 🚀 **減少批次間隔**：從 500ms → 200ms
- 📊 **進度日誌**：顯示 "正在處理 1/4" 等進度信息
- ✅ **失敗不影響後續**：某個運動失敗，其他運動繼續上傳

---

## 時間節省計算

### 單個運動（手機鎖定情況）
- **舊流程**：心率 (2.5分) + 速度 (1.5分) + 步頻 (2.5分) = **6.5 分鐘**
- **新流程**：檢測到鎖定 → **立即失敗 (< 1 秒)**
- **節省時間**：**6.5 分鐘**

### 單個運動（第三方數據源）
- **舊流程**：心率 (2.5分) + 速度 (1.5分) + 步頻 (2.5分) = **6.5 分鐘**
- **新流程**：識別第三方來源 → 1 次重試 × 5 秒 = **15 秒**
- **節省時間**：**6 分鐘**

### 單個運動（正常情況，數據完整）
- **舊流程**：延遲 20 秒 + 上傳 → **約 25 秒**
- **新流程**：延遲 5 秒 + 上傳 → **約 10 秒**
- **節省時間**：**15 秒**

### 批量上傳（4 筆運動，1 筆問題運動）
- **舊流程**：問題運動阻塞整個批次 → **> 10 分鐘**
- **新流程**：60 秒超時跳過，其他運動繼續 → **約 2 分鐘**
- **節省時間**：**> 8 分鐘**

---

## 數據驗證邏輯

### 所有運動必需
- ✅ **心率數據** ≥ 2 筆

### Apple Watch 跑步運動額外必需
僅適用於 Apple Watch、iPhone 等 Apple 設備錄製的跑步運動：

- ✅ **速度/距離來源**（優先級順序）：
  1. GPS 速度樣本 ≥ 2 筆
  2. 分圈距離 > 0
  3. 總距離 > 0
  4. 有步頻數據（後端可推算速度）

- ✅ **步頻或分圈**（至少一個）：
  - 步頻數據 ≥ 2 筆
  - **或** 有分圈資料

### 第三方設備跑步運動（Garmin/Polar/Suunto 等）
**放寬要求**：只需要心率數據 ≥ 2 筆

- ℹ️ 原因：第三方設備同步到 Apple Health 的數據通常只有摘要信息
- ℹ️ 詳細的配速曲線、步頻等數據在其原平台（如 Garmin Connect）上
- ℹ️ 我們仍會嘗試獲取速度、步頻等數據，但不會因為缺失而拒絕上傳

### 設備識別邏輯（重要）

**正面識別策略**：使用雙重正面識別來確保安全性

1. **Apple 設備識別**（Bundle ID + Source Name）：
   - Bundle ID: `com.apple.health`, `com.apple.healthd`, `com.apple.Fitness`
   - Source Name: `Health`, `Apple Watch`, `iPhone`, `健康`, `Fitness`

2. **已知第三方設備識別**（Bundle ID + Source Name）：
   - Garmin: `com.garmin.connect.mobile` / `Garmin Connect`
   - Polar: `com.polar.polarflow` / `Polar Flow`
   - Suunto: `com.suunto.suuntolink` / `Suunto`
   - Strava: `com.strava.strava` / `Strava`
   - 等等...

3. **未知來源處理**：
   - ⚠️ 未知來源 → **套用嚴格驗證**（與 Apple Watch 相同）
   - ✅ 這確保不會誤判 Apple Watch 為第三方
   - ✅ 避免上傳不完整的資料
   - 📝 系統會記錄未知來源的詳細資訊，方便後續添加到已知列表

**為什麼這樣設計？**
- **安全優先**：寧可拒絕上傳，也不要上傳不完整的資料
- **避免誤判**：如果有新的 Apple 設備/App，不會被錯誤地套用寬鬆驗證
- **可擴展性**：發現新的第三方設備時，可以輕鬆添加到已知列表

### 可選數據
- 步幅（Stride Length）
- 觸地時間（Ground Contact Time）
- 垂直振幅（Vertical Oscillation）
- GPS 速度樣本（第三方設備）
- 步頻數據（第三方設備）

---

## 建議與最佳實踐

### 對於用戶
1. **解鎖手機後上傳**：避免 "Protected health data is inaccessible" 錯誤
2. **使用 Apple Watch 直接錄製**：數據最完整，上傳最快
3. **Garmin 用戶建議**：
   - 如需完整配速分析，使用 Garmin Connect 直連（而非同步到 Apple Health）
   - 或者理解 Apple Health 同步的數據可能缺少詳細曲線

### 對於開發者
1. **日誌優化**：現在會清楚標註「第三方數據源」、「手機鎖定」等狀態
2. **錯誤追蹤**：失敗原因會記錄到 WorkoutUploadTracker
3. **用戶體驗**：不再有長時間無反應的情況

---

## 總結

### 改進前的痛點
- ⏱️ 一個運動可能需要 6-10 分鐘才能確定失敗
- 🔒 手機鎖定時完全卡住
- 📱 Garmin 數據無法正確識別
- 🚫 批量上傳容易整個卡死

### 改進後的優勢
- ⚡ 正常運動 10 秒內上傳完成
- 🔒 手機鎖定立即檢測並提示
- 📱 Garmin 數據 15 秒內處理完畢
- ✅ 批量上傳有超時保護，不會卡住

### 平均時間節省
- 正常運動：節省 **15 秒**
- 手機鎖定：節省 **6.5 分鐘**
- Garmin 數據：節省 **6 分鐘**
- 批量上傳：節省 **> 8 分鐘**

---

## 參考
- 代碼文件：`Havital/Services/AppleHealthWorkoutUploadService.swift`
- 關鍵函數：
  - `retryFetchingData()` - 重試邏輯（第 501-586 行）
  - `performBatchUpload()` - 批量上傳（第 320-388 行）
  - `isThirdPartyWorkout()` - 第三方識別（第 581-585 行）
